<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper  namespace="kr.co.seoulit.statement.incomeStatement.dao.IncomeStatementDAO">

	<resultMap type="incomeStatementTO" id="incomeStatementResult">
		<result property="displayName" column="DISPLAY_NAME"/>
	   	<result property="currentPeriodLeftCol" column="CURRENT_PERIOD_LEFT_COL"/>
	   	<result property="currentPeriodRightCol" column="CURRENT_PERIOD_RIGHT_COL"/>
	   	<result property="PreviousPeriodLeftCol" column="PREVIOUS_PERIOD_LEFT_COL"/>
	   	<result property="PreviousPeriodRightCol" column="PREVIOUS_PERIOD_RIGHT_COL"/>
	</resultMap>


	<select id="selectIncomeStatement" parameterType="map" resultMap="incomeStatementResult">
 <![CDATA[

WITH CURRENT_SLIP AS (
SELECT * FROM SLIP
WHERE APPROVAL_DATE <= #{approvalDate}
) ,

CURRENT_INCOME_STATEMENTS AS (
SELECT J.BALANCE_DIVISION, J.ACCOUNT_INNER_CODE, J.ACCOUNT_NAME,
    NVL( J.LEFT_DEBTOR_PRICE , 0 ) AS LEFT_DEBTOR_PRICE,
    NVL( J.RIGHT_CREDITS_PRICE , 0 ) AS RIGHT_CREDITS_PRICE,
    A.ACCOUNT_CHARACTER ,
    A.PARENT_ACCOUNT_INNER_CODE
FROM CURRENT_SLIP S, JOURNAL J, ACCOUNT A
WHERE S.SLIP_NO = J.SLIP_NO (+)
    AND J.ACCOUNT_INNER_CODE = A.ACCOUNT_INNER_CODE (+)
),

CURRENT_TOTAL_SALES AS (SELECT NVL(SUM(NVL(RIGHT_CREDITS_PRICE,0)-NVL(LEFT_DEBTOR_PRICE,0)),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE PARENT_ACCOUNT_INNER_CODE='0401-0430'), --매출

ELEMENTRY_PRODUCT_STOCK AS (SELECT MINUS_PRICE AS PRICE FROM EARLY_STATEMENTS_DETAIL WHERE ITEM_NAME='기말상품 재고액'), -- 전기 기말상품 재고액=당기 기초상품재고액

CURRENT_PRODUCT_PURCHASES AS (SELECT NVL(SUM( LEFT_DEBTOR_PRICE - RIGHT_CREDITS_PRICE ),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE ACCOUNT_INNER_CODE='0146'), --당기 상품 총 매입액(당기총매입)

CURRENT_PURCHASES_RETURNS AS (SELECT NVL(SUM( LEFT_DEBTOR_PRICE - RIGHT_CREDITS_PRICE ),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE ACCOUNT_INNER_CODE='0147'), --애누리

CURRENT_PURCHASES_DISCOUNT AS (SELECT NVL(SUM( LEFT_DEBTOR_PRICE - RIGHT_CREDITS_PRICE ),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE ACCOUNT_INNER_CODE='0148'), -- 매입할인


CURRENT_FINAL_INVENSTOCK AS (SELECT NVL(NVL(EPS.PRICE,0)+NVL(CPP.PRICE,0)-NVL(CPR.PRICE,0)-NVL(CPD.PRICE,0),0) AS PRICE FROM CURRENT_PRODUCT_PURCHASES CPP,CURRENT_PURCHASES_RETURNS CPR,CURRENT_PURCHASES_DISCOUNT CPD,ELEMENTRY_PRODUCT_STOCK EPS), --당기 기말상품 재고액

/* 당기 기말상품재고액 = 당기 기초상품재고액 ( = 전기 기말상품재고액 ) + 당기상품 매입액
                                - 매입환출및에누리 - 매입할인 */

CURRENT_MANAGEMENT_COST AS (SELECT NVL(SUM ( LEFT_DEBTOR_PRICE - RIGHT_CREDITS_PRICE ),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE PARENT_ACCOUNT_INNER_CODE='0801-0900'), --판매관리비

 /* 당기분 영업이익 = 매출총이익 - 판매관리비 */
CURRENT_BUSINESS_PROFIT AS (SELECT NVL(NVL(CTS.PRICE,0)-NVL(CMC.PRICE,0),0) AS PRICE FROM CURRENT_TOTAL_SALES CTS,CURRENT_MANAGEMENT_COST CMC), --- 당기 영업이익(총매출-판관비)

CUR_EXTRA_BUSINESS_PROPIT AS (SELECT NVL(SUM(RIGHT_CREDITS_PRICE-LEFT_DEBTOR_PRICE),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE PARENT_ACCOUNT_INNER_CODE='0901-0950'),--영업외수익총액

CUR_EXTRA_BUSINESS_LOSS AS (SELECT NVL(SUM(LEFT_DEBTOR_PRICE-RIGHT_CREDITS_PRICE),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE PARENT_ACCOUNT_INNER_CODE='0951-0997'), ---영업외 비용 총액

CUR_NON_TAXED_TOTAL_P AS (SELECT CBP.PRICE+CEBP.PRICE-CEBL.PRICE AS PRICE FROM CURRENT_BUSINESS_PROFIT CBP,CUR_EXTRA_BUSINESS_PROPIT CEBP,CUR_EXTRA_BUSINESS_LOSS CEBL), ----소득세 차감전 이익

CURRENT_TAX AS(SELECT SUM( NVL(LEFT_DEBTOR_PRICE,0) - NVL(RIGHT_CREDITS_PRICE,0)) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE PARENT_ACCOUNT_INNER_CODE='0998-0999'), ----- 당기세금

CUR_MANAGECOST_DETAIL AS(SELECT ACCOUNT_INNER_CODE,ACCOUNT_NAME,SUM(LEFT_DEBTOR_PRICE - RIGHT_CREDITS_PRICE)AS PRICE  FROM CURRENT_INCOME_STATEMENTS WHERE PARENT_ACCOUNT_INNER_CODE='0801-0900' GROUP BY ACCOUNT_INNER_CODE,ACCOUNT_NAME), ---당기분 판관비상세


CUR_EXT_BUSINESS_PROP_DET AS (SELECT ACCOUNT_INNER_CODE,PARENT_ACCOUNT_INNER_CODE,ACCOUNT_NAME, NVL(SUM(RIGHT_CREDITS_PRICE-LEFT_DEBTOR_PRICE),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE PARENT_ACCOUNT_INNER_CODE='0901-0950' GROUP BY ACCOUNT_INNER_CODE,PARENT_ACCOUNT_INNER_CODE,ACCOUNT_NAME), --당기분 영업외수익상세
CUR_EXT_BUSINESS_LOSS_DET AS (SELECT ACCOUNT_INNER_CODE,PARENT_ACCOUNT_INNER_CODE,ACCOUNT_NAME, NVL(SUM(LEFT_DEBTOR_PRICE-RIGHT_CREDITS_PRICE),0) AS PRICE FROM CURRENT_INCOME_STATEMENTS WHERE PARENT_ACCOUNT_INNER_CODE='0951-0997' GROUP BY ACCOUNT_INNER_CODE,PARENT_ACCOUNT_INNER_CODE,ACCOUNT_NAME), --당기분 영업외손실상세
----여기까지 당기분 위드문


EALRY_INCOME_STATEMNTS AS (SELECT es.ACCOUNT_PERIOD_NO,es.ACCOUNT_INNER_CODE,a.parent_account_inner_code,es.ACCOUNT_NAME,(NVL(LEFT_DEBTOR_PRICE,0)+NVL(RIGHT_CREDITS_PRICE,0)) AS PRICE
FROM EARLY_STATEMENTS es,account a WHERE es.ACCOUNT_INNER_CODE=a.ACCOUNT_INNER_CODE AND es.STATEMENTS_DIVISION='손익'),

EALRY_PRESENT AS(SELECT ACCOUNT_PERIOD_NO,ACCOUNT_INNER_CODE,ACCOUNT_NAME,PRICE FROM EALRY_INCOME_STATEMNTS WHERE ACCOUNT_NAME IN('상품매출','상품매출원가') ORDER BY account_inner_code),

TOTAL_EALRY_PRESENT AS(SELECT price-lag(price)OVER(ORDER BY price) AS PRICE FROM EALRY_PRESENT),

TOTAL_MANAGEMENT_PRICE AS ( SELECT SUM(price) AS PRICE FROM EALRY_INCOME_STATEMNTS e,account a WHERE e.account_inner_code=a.account_inner_code AND a.parent_account_inner_code='0801-0900'),

BUSINESS_INCOME AS (SELECT MAX(tep.price)-MAX(tmp.price) AS PRICE FROM TOTAL_EALRY_PRESENT tep,TOTAL_MANAGEMENT_PRICE tmp),

EX_BUSINESS_INCOME AS (SELECT SUM(price) AS PRICE FROM EALRY_INCOME_STATEMNTS WHERE parent_account_inner_code='0901-0950'),

EX_BUSINESS_LOSS AS (SELECT SUM(price) AS PRICE FROM EALRY_INCOME_STATEMNTS WHERE parent_account_inner_code='0951-0997'),

NO_TAXED_INCOME AS (SELECT (bi.price+ebi.price)-ebl.price AS PRICE FROM BUSINESS_INCOME bi,EX_BUSINESS_INCOME ebi,EX_BUSINESS_LOSS ebl),

TAX AS (SELECT * FROM EALRY_INCOME_STATEMNTS WHERE parent_account_inner_code='0998-0999'),

PURE_INCOME AS (SELECT ntp.price-t.price AS PRICE FROM NO_TAXED_INCOME ntp,TAX t),

EARLY_MANAGEMENT_PRICE AS (SELECT ACCOUNT_NAME,PRICE,ACCOUNT_INNER_CODE FROM EALRY_INCOME_STATEMNTS WHERE PARENT_ACCOUNT_INNER_CODE ='0801-0900'),--전기분판관비상세

EX_BUSINESS_INC_DET AS (SELECT ACCOUNT_NAME,PRICE,ACCOUNT_INNER_CODE,parent_account_inner_code FROM EALRY_INCOME_STATEMNTS WHERE parent_account_inner_code='0901-0950'), -- 전기분 영업외수익상세
EX_BUSINESS_LOSS_DET AS (SELECT ACCOUNT_NAME,PRICE,ACCOUNT_INNER_CODE,parent_account_inner_code FROM EALRY_INCOME_STATEMNTS WHERE parent_account_inner_code='0951-0997') -- 전기분 영업외 손실 상세
---------여기까지 전기분 위드문


SELECT UNISTR('1. 매출액') AS DISPLAY_NAME,
    NULL AS CURRENT_PERIOD_LEFT_COL,
    ( SELECT PRICE FROM CURRENT_TOTAL_SALES ) AS CURRENT_PERIOD_RIGHT_COL,
    NULL AS PREVIOUS_PERIOD_LEFT_COL,
    ( SELECT PRICE FROM EALRY_PRESENT WHERE ACCOUNT_NAME='상품매출' ) AS PREVIOUS_PERIOD_RIGHT_COL
FROM DUAL
UNION ALL
SELECT EP.ACCOUNT_NAME,NVL(CTS.PRICE,0),NULL,EP.PRICE,NULL FROM EALRY_PRESENT EP,CURRENT_TOTAL_SALES CTS
WHERE ACCOUNT_NAME='상품매출'
UNION ALL
SELECT UNISTR('2. 매출원가'),NULL,(SELECT NVL(EPS.PRICE,0)+NVL(CPP.PRICE,0)-NVL(CPR.PRICE,0)-NVL(CPD.PRICE,0)-NVL(CFT.PRICE,0) FROM ELEMENTRY_PRODUCT_STOCK EPS,CURRENT_PRODUCT_PURCHASES CPP,CURRENT_PURCHASES_RETURNS CPR,CURRENT_PURCHASES_DISCOUNT CPD,CURRENT_FINAL_INVENSTOCK CFT),NULL,( SELECT PRICE FROM EALRY_PRESENT WHERE ACCOUNT_NAME='상품매출원가'  )  --(차변) 기초상품 재고액 + 당기상품 매입액 = (대변) 기말상품재고액 + 매출원가

--당기 기초상품재고액+당기상품매입액-기말상품재고액=매출원가
FROM DUAL
UNION ALL --- 개별 매출원가
SELECT ITEM_NAME
,(CASE CALCULATED_ORDER WHEN 1 THEN (SELECT NVL(PRICE,0) FROM ELEMENTRY_PRODUCT_STOCK)
 WHEN 2 THEN (SELECT NVL(PRICE,0) FROM CURRENT_PRODUCT_PURCHASES)
  WHEN 5 THEN (SELECT NVL(PRICE,0) FROM CURRENT_FINAL_INVENSTOCK)
  WHEN 3 THEN (SELECT NVL(PRICE,0) FROM CURRENT_PURCHASES_RETURNS)
  WHEN 4 THEN(SELECT NVL(PRICE,0) FROM CURRENT_PURCHASES_DISCOUNT)
   END),NULL,ABS(NVL(PLUS_PRICE,0)-NVL(MINUS_PRICE,0)) AS PRICE,NULL FROM EARLY_STATEMENTS_DETAIL
UNION ALL
SELECT Unistr('3.매출총손익(1-2)') AS account_name,NULL
,(SELECT MAX(PRICE) FROM CURRENT_TOTAL_SALES),NULL
,(SELECT MAX(PRICE) FROM TOTAL_EALRY_PRESENT) FROM DUAL
UNION ALL
SELECT Unistr('4.판매관리비') AS account_name,NULL,PRICE,NULL,(SELECT PRICE FROM TOTAL_MANAGEMENT_PRICE) FROM CURRENT_MANAGEMENT_COST
UNION ALL
SELECT DECODE(EMP.ACCOUNT_NAME,NULL,CMD.ACCOUNT_NAME,EMP.ACCOUNT_NAME) AS ACCOUNT_NAME,NVL(CMD.PRICE,0),NULL,NVL(EMP.PRICE,0),NULL  FROM CUR_MANAGECOST_DETAIL CMD,EARLY_MANAGEMENT_PRICE EMP WHERE CMD.ACCOUNT_INNER_CODE=EMP.ACCOUNT_INNER_CODE(+)
UNION ALL
SELECT Unistr('5.영업이익(3-4)') AS account_name,NULL,PRICE,NULL,(SELECT MAX(price) FROM BUSINESS_INCOME) FROM CURRENT_BUSINESS_PROFIT
UNION ALL
SELECT Unistr('6.영업외 수익') AS account_name,NULL,PRICE,NULL,(SELECT MAX(price) FROM EX_BUSINESS_INCOME) FROM CUR_EXTRA_BUSINESS_PROPIT
UNION ALL
SELECT DECODE(EBID.ACCOUNT_NAME,NULL,CEBPT.ACCOUNT_NAME,EBID.ACCOUNT_NAME) AS ACCOUNT_NAME,NVL(CEBPT.PRICE,0),NULL,EBID.PRICE,NULL FROM CUR_EXT_BUSINESS_PROP_DET CEBPT,EX_BUSINESS_INC_DET EBID WHERE CEBPT.ACCOUNT_INNER_CODE=EBID.ACCOUNT_INNER_CODE(+)
UNION ALL
SELECT Unistr('7.영업외 비용') AS account_name,NULL,PRICE,NULL,(SELECT MAX(price) FROM EX_BUSINESS_LOSS) FROM CUR_EXTRA_BUSINESS_LOSS
UNION ALL
SELECT DECODE(EBLD.ACCOUNT_NAME,NULL,CBLD.ACCOUNT_NAME,EBLD.ACCOUNT_NAME) AS ACCOUNT_NAME,NVL(CBLD.PRICE,0),NULL,NVL(EBLD.PRICE,0),NULL FROM CUR_EXT_BUSINESS_LOSS_DET CBLD,EX_BUSINESS_LOSS_DET EBLD WHERE CBLD.ACCOUNT_INNER_CODE=EBLD.ACCOUNT_INNER_CODE(+)
UNION ALL
SELECT Unistr('8.소득세차감전 이익') AS account_name,NULL,NVL(PRICE,0),NULL,(SELECT MAX(price) FROM NO_TAXED_INCOME) FROM CUR_NON_TAXED_TOTAL_P
UNION ALL
SELECT Unistr('9.소득세등') AS account_name,NULL,nvl(PRICE,0),NULL,(SELECT MAX(price) FROM TAX) FROM CURRENT_TAX
UNION ALL
SELECT Unistr('10.당기순 이익') AS account_name,NULL,nvl(CNTP.PRICE,0)-NVL(CT.PRICE,0),NULL,(SELECT NTI.price-T.PRICE FROM NO_TAXED_INCOME NTI,TAX T) FROM CUR_NON_TAXED_TOTAL_P CNTP,CURRENT_TAX CT


	   ]]>
	</select>



</mapper>

